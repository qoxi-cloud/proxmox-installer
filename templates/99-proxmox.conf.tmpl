# ============================================
# Proxmox VE Optimized Kernel Parameters
# For dedicated servers with NVMe
# ============================================

# ------------------------------------------
# Network: IP Forwarding for VMs/Containers
# ------------------------------------------
net.ipv4.ip_forward=1
net.ipv6.conf.all.forwarding=1

# ------------------------------------------
# Network: Connection Tracking & Performance
# ------------------------------------------
net.netfilter.nf_conntrack_max=1048576
net.netfilter.nf_conntrack_tcp_timeout_established=28800
net.core.somaxconn=65535
net.core.netdev_max_backlog=65535
net.ipv4.tcp_max_syn_backlog=65535

# ------------------------------------------
# Network: TCP Congestion Control (BBR)
# ------------------------------------------
# BBR: Modern congestion control from Google
# Improves throughput and reduces latency vs cubic
net.core.default_qdisc=fq
net.ipv4.tcp_congestion_control=bbr

# ------------------------------------------
# Network: TCP Performance Tuning
# ------------------------------------------
# TCP socket buffer sizes (optimized for 10Gbit+ links)
net.core.rmem_max=134217728
net.core.wmem_max=134217728
net.ipv4.tcp_rmem=4096 87380 67108864
net.ipv4.tcp_wmem=4096 65536 67108864

# TCP performance features
net.ipv4.tcp_window_scaling=1
net.ipv4.tcp_timestamps=1

# VPN/Tunnel optimizations (Tailscale, WireGuard)
net.ipv4.tcp_mtu_probing=1
net.ipv4.tcp_fastopen=3
net.ipv4.tcp_fin_timeout=15
net.ipv4.tcp_tw_reuse=1
net.ipv4.tcp_keepalive_time=600
net.ipv4.tcp_keepalive_probes=5
net.ipv4.tcp_keepalive_intvl=15
net.ipv4.tcp_slow_start_after_idle=0

# ------------------------------------------
# Network: Security & Anti-Spoofing
# ------------------------------------------
# SYN flood protection
net.ipv4.tcp_syncookies=1

# Log packets with impossible source addresses
net.ipv4.conf.all.log_martians=1

# Reverse path filtering (anti-spoofing)
net.ipv4.conf.all.rp_filter=1
net.ipv4.conf.default.rp_filter=1

# ------------------------------------------
# Memory: Virtual Memory Tuning
# ------------------------------------------
# Reduce swappiness for server workloads (default 60)
vm.swappiness=10

# Percentage of RAM for dirty pages before write starts
vm.dirty_ratio=15

# Percentage of RAM for dirty pages before background write
vm.dirty_background_ratio=5

# How long (centisecs) data can stay in page cache before write
vm.dirty_expire_centisecs=3000
vm.dirty_writeback_centisecs=500

# Allow more aggressive memory overcommit for VMs
vm.overcommit_memory=1

# Minimum free memory (64MB)
vm.min_free_kbytes=65536

# ------------------------------------------
# File System: Increase inotify limits
# ------------------------------------------
fs.inotify.max_user_watches=524288
fs.inotify.max_user_instances=512
fs.file-max=2097152

# ------------------------------------------
# Kernel: Panic behavior
# ------------------------------------------
# Reboot 10 seconds after kernel panic
kernel.panic=10
kernel.panic_on_oops=1

# ------------------------------------------
# Security: Kernel hardening
# ------------------------------------------
# Restrict kernel pointer exposure (KASLR protection)
kernel.kptr_restrict=2

# Restrict dmesg access to root (prevent kernel address leaks)
kernel.dmesg_restrict=1

# Prevent unprivileged user namespace creation (container escape mitigation)
kernel.unprivileged_userns_clone=0

# Disable unprivileged eBPF (prevent kernel exploits via BPF verifier bugs)
kernel.unprivileged_bpf_disabled=1

# Prevent NULL pointer dereference exploits
vm.mmap_min_addr=65536

# Disable magic SysRq key (security)
kernel.sysrq=0

# ------------------------------------------
# I/O Scheduler: Optimized for NVMe
# ------------------------------------------
# Note: NVMe drives use 'none' scheduler by default
# which is optimal. This is set via udev rules.
