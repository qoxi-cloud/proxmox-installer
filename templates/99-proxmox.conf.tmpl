# ============================================
# Proxmox VE Optimized Kernel Parameters
# For Hetzner dedicated servers with NVMe
# ============================================

# ------------------------------------------
# Network: IP Forwarding for VMs/Containers
# ------------------------------------------
net.ipv4.ip_forward=1
net.ipv6.conf.all.forwarding=1

# ------------------------------------------
# Network: Connection Tracking & Performance
# ------------------------------------------
net.netfilter.nf_conntrack_max=1048576
net.core.somaxconn=65535
net.core.netdev_max_backlog=65535
net.ipv4.tcp_max_syn_backlog=65535

# ------------------------------------------
# Network: TCP Performance Tuning
# ------------------------------------------
net.ipv4.tcp_fin_timeout=15
net.ipv4.tcp_tw_reuse=1
net.ipv4.tcp_keepalive_time=600
net.ipv4.tcp_keepalive_probes=5
net.ipv4.tcp_keepalive_intvl=15
net.ipv4.tcp_slow_start_after_idle=0

# ------------------------------------------
# Memory: Virtual Memory Tuning
# ------------------------------------------
# Reduce swappiness for server workloads (default 60)
vm.swappiness=10

# Percentage of RAM for dirty pages before write starts
vm.dirty_ratio=15

# Percentage of RAM for dirty pages before background write
vm.dirty_background_ratio=5

# How long (centisecs) data can stay in page cache before write
vm.dirty_expire_centisecs=3000
vm.dirty_writeback_centisecs=500

# Allow more aggressive memory overcommit for VMs
vm.overcommit_memory=1

# Minimum free memory (64MB)
vm.min_free_kbytes=65536

# ------------------------------------------
# File System: Increase inotify limits
# ------------------------------------------
fs.inotify.max_user_watches=524288
fs.inotify.max_user_instances=512
fs.file-max=2097152

# ------------------------------------------
# Kernel: Panic behavior
# ------------------------------------------
# Reboot 10 seconds after kernel panic
kernel.panic=10
kernel.panic_on_oops=1

# ------------------------------------------
# Security: Kernel hardening
# ------------------------------------------
# Restrict kernel pointer exposure
kernel.kptr_restrict=2

# Restrict dmesg access to root
kernel.dmesg_restrict=1

# Disable magic SysRq key (security)
kernel.sysrq=0

# ------------------------------------------
# I/O Scheduler: Optimized for NVMe
# ------------------------------------------
# Note: NVMe drives use 'none' scheduler by default
# which is optimal. This is set via udev rules.
