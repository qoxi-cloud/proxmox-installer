# Auditd rules for Proxmox VE administrative action tracking
# Generated by proxmox-installer installer

# Remove any existing rules
-D

# Buffer Size - increase for busy systems
-b 8192

# Failure Mode - 1 = printk, 2 = panic
-f 1

# =============================================================================
# User/Group modifications
# =============================================================================
-a always,exit -F path=/etc/passwd -F perm=wa -F key=identity
-a always,exit -F path=/etc/shadow -F perm=wa -F key=identity
-a always,exit -F path=/etc/group -F perm=wa -F key=identity
-a always,exit -F path=/etc/gshadow -F perm=wa -F key=identity
-a always,exit -F path=/etc/security/opasswd -F perm=wa -F key=identity

# =============================================================================
# Privileged commands (track all users including root)
# =============================================================================
-a always,exit -F arch=b64 -F path=/usr/bin/sudo -F perm=x -F key=privileged
-a always,exit -F arch=b64 -F path=/usr/bin/su -F perm=x -F key=privileged
-a always,exit -F arch=b64 -F path=/usr/bin/passwd -F perm=x -F key=privileged
-a always,exit -F arch=b64 -F path=/usr/bin/chsh -F perm=x -F key=privileged
-a always,exit -F arch=b64 -F path=/usr/bin/chfn -F perm=x -F key=privileged
-a always,exit -F arch=b64 -F path=/usr/bin/newgrp -F perm=x -F key=privileged
-a always,exit -F arch=b64 -F path=/usr/bin/gpasswd -F perm=x -F key=privileged
-a always,exit -F arch=b64 -F path=/usr/bin/usermod -F perm=x -F key=privileged
-a always,exit -F arch=b64 -F path=/usr/sbin/useradd -F perm=x -F key=privileged
-a always,exit -F arch=b64 -F path=/usr/sbin/userdel -F perm=x -F key=privileged
-a always,exit -F arch=b64 -F path=/usr/sbin/groupadd -F perm=x -F key=privileged
-a always,exit -F arch=b64 -F path=/usr/sbin/groupdel -F perm=x -F key=privileged
-a always,exit -F arch=b64 -F path=/usr/sbin/groupmod -F perm=x -F key=privileged

# =============================================================================
# SSH configuration changes
# =============================================================================
-a always,exit -F path=/etc/ssh/sshd_config -F perm=wa -F key=sshd_config
-a always,exit -F dir=/etc/ssh/sshd_config.d -F perm=wa -F key=sshd_config
-a always,exit -F dir=/root/.ssh -F perm=wa -F key=ssh_keys

# =============================================================================
# Network configuration
# =============================================================================
-a always,exit -F path=/etc/network/interfaces -F perm=wa -F key=network_config
-a always,exit -F dir=/etc/network/interfaces.d -F perm=wa -F key=network_config
-a always,exit -F path=/etc/hosts -F perm=wa -F key=network_config
-a always,exit -F path=/etc/resolv.conf -F perm=wa -F key=network_config
-a always,exit -F path=/etc/hostname -F perm=wa -F key=network_config

# =============================================================================
# Proxmox VE configuration
# =============================================================================
-a always,exit -F dir=/etc/pve -F perm=wa -F key=proxmox_config
-a always,exit -F dir=/var/lib/pve-cluster -F perm=wa -F key=proxmox_cluster
-a always,exit -F path=/etc/vzdump.conf -F perm=wa -F key=proxmox_backup

# Proxmox CLI tools - VM/container management
-a always,exit -F arch=b64 -F path=/usr/sbin/qm -F perm=x -F key=proxmox_vm
-a always,exit -F arch=b64 -F path=/usr/sbin/pct -F perm=x -F key=proxmox_container

# Proxmox API and management tools (/usr/bin/)
-a always,exit -F arch=b64 -F path=/usr/bin/pvesh -F perm=x -F key=proxmox_api
-a always,exit -F arch=b64 -F path=/usr/bin/pveam -F perm=x -F key=proxmox_templates
-a always,exit -F arch=b64 -F path=/usr/bin/pvecm -F perm=x -F key=proxmox_cluster
-a always,exit -F arch=b64 -F path=/usr/bin/pveum -F perm=x -F key=proxmox_users
-a always,exit -F arch=b64 -F path=/usr/bin/pvesr -F perm=x -F key=proxmox_replication
-a always,exit -F arch=b64 -F path=/usr/bin/pvenode -F perm=x -F key=proxmox_node
-a always,exit -F arch=b64 -F path=/usr/bin/pvesubscription -F perm=x -F key=proxmox_subscription

# Proxmox backup/restore
-a always,exit -F arch=b64 -F path=/usr/bin/vzdump -F perm=x -F key=proxmox_backup
-a always,exit -F arch=b64 -F path=/usr/sbin/qmrestore -F perm=x -F key=proxmox_restore

# Proxmox storage management
-a always,exit -F arch=b64 -F path=/usr/bin/pvesm -F perm=x -F key=proxmox_storage
-a always,exit -F arch=b64 -F path=/usr/bin/pveceph -F perm=x -F key=proxmox_ceph

# Proxmox firewall
-a always,exit -F dir=/etc/pve/firewall -F perm=wa -F key=proxmox_firewall
-a always,exit -F arch=b64 -F path=/usr/sbin/pve-firewall -F perm=x -F key=proxmox_firewall

# =============================================================================
# System startup and services
# =============================================================================
-a always,exit -F path=/etc/rc.local -F perm=wa -F key=init
-a always,exit -F dir=/etc/init.d -F perm=wa -F key=init
-a always,exit -F dir=/etc/systemd/system -F perm=wa -F key=systemd
-a always,exit -F dir=/usr/lib/systemd/system -F perm=wa -F key=systemd

# =============================================================================
# Kernel modules
# =============================================================================
-a always,exit -F arch=b64 -F path=/usr/sbin/insmod -F perm=x -F key=modules
-a always,exit -F arch=b64 -F path=/usr/sbin/rmmod -F perm=x -F key=modules
-a always,exit -F arch=b64 -F path=/usr/sbin/modprobe -F perm=x -F key=modules
-a always,exit -F dir=/etc/modprobe.d -F perm=wa -F key=modules

# =============================================================================
# Cron jobs
# =============================================================================
-a always,exit -F path=/etc/crontab -F perm=wa -F key=cron
-a always,exit -F dir=/etc/cron.d -F perm=wa -F key=cron
-a always,exit -F dir=/etc/cron.daily -F perm=wa -F key=cron
-a always,exit -F dir=/etc/cron.hourly -F perm=wa -F key=cron
-a always,exit -F dir=/etc/cron.monthly -F perm=wa -F key=cron
-a always,exit -F dir=/etc/cron.weekly -F perm=wa -F key=cron
-a always,exit -F dir=/var/spool/cron/crontabs -F perm=wa -F key=cron

# =============================================================================
# Sudoers configuration
# =============================================================================
-a always,exit -F path=/etc/sudoers -F perm=wa -F key=sudoers
-a always,exit -F dir=/etc/sudoers.d -F perm=wa -F key=sudoers

# =============================================================================
# Time changes
# =============================================================================
-a always,exit -F arch=b64 -S adjtimex -S settimeofday -F key=time_change
-a always,exit -F arch=b64 -S clock_settime -F key=time_change
-a always,exit -F path=/etc/localtime -F perm=wa -F key=time_change
-a always,exit -F path=/etc/timezone -F perm=wa -F key=time_change

# =============================================================================
# Login/logout events
# =============================================================================
-a always,exit -F path=/var/log/faillog -F perm=wa -F key=logins
-a always,exit -F path=/var/log/lastlog -F perm=wa -F key=logins
-a always,exit -F path=/var/run/utmp -F perm=wa -F key=session
-a always,exit -F path=/var/log/wtmp -F perm=wa -F key=logins
-a always,exit -F path=/var/log/btmp -F perm=wa -F key=logins

# =============================================================================
# PAM configuration
# =============================================================================
-a always,exit -F dir=/etc/pam.d -F perm=wa -F key=pam
-a always,exit -F dir=/etc/security -F perm=wa -F key=pam

# =============================================================================
# Package management
# =============================================================================
-a always,exit -F arch=b64 -F path=/usr/bin/apt -F perm=x -F key=package_management
-a always,exit -F arch=b64 -F path=/usr/bin/apt-get -F perm=x -F key=package_management
-a always,exit -F arch=b64 -F path=/usr/bin/dpkg -F perm=x -F key=package_management
-a always,exit -F arch=b64 -F path=/usr/bin/aptitude -F perm=x -F key=package_management

# =============================================================================
# Firewall changes (iptables/nftables)
# =============================================================================
-a always,exit -F arch=b64 -F path=/usr/sbin/iptables -F perm=x -F key=firewall
-a always,exit -F arch=b64 -F path=/usr/sbin/ip6tables -F perm=x -F key=firewall
-a always,exit -F arch=b64 -F path=/usr/sbin/iptables-restore -F perm=x -F key=firewall
-a always,exit -F arch=b64 -F path=/usr/sbin/ip6tables-restore -F perm=x -F key=firewall
-a always,exit -F arch=b64 -F path=/usr/sbin/nft -F perm=x -F key=firewall

# =============================================================================
# ZFS administration (common on Proxmox)
# =============================================================================
-a always,exit -F arch=b64 -F path=/usr/sbin/zpool -F perm=x -F key=zfs_admin
-a always,exit -F arch=b64 -F path=/usr/sbin/zfs -F perm=x -F key=zfs_admin

# =============================================================================
# Fail2Ban configuration and management
# =============================================================================
-a always,exit -F dir=/etc/fail2ban -F perm=wa -F key=fail2ban_config
-a always,exit -F arch=b64 -F path=/usr/bin/fail2ban-client -F perm=x -F key=fail2ban_admin
-a always,exit -F arch=b64 -F path=/usr/bin/fail2ban-server -F perm=x -F key=fail2ban_admin

# =============================================================================
# Make rules immutable (must be last rule)
# =============================================================================
-e 2
