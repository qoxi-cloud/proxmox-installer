# Auditd rules for Proxmox VE administrative action tracking
# Generated by proxmox-installer installer

# Remove any existing rules
-D

# Buffer Size - increase for busy systems
-b 8192

# Failure Mode - 1 = printk, 2 = panic
-f 1

# =============================================================================
# User/Group modifications
# =============================================================================
-w /etc/passwd -p wa -k identity
-w /etc/shadow -p wa -k identity
-w /etc/group -p wa -k identity
-w /etc/gshadow -p wa -k identity
-w /etc/security/opasswd -p wa -k identity

# =============================================================================
# Privileged commands (track all users including root)
# =============================================================================
-a always,exit -F path=/usr/bin/sudo -F perm=x -k privileged
-a always,exit -F path=/usr/bin/su -F perm=x -k privileged
-a always,exit -F path=/usr/bin/passwd -F perm=x -k privileged
-a always,exit -F path=/usr/bin/chsh -F perm=x -k privileged
-a always,exit -F path=/usr/bin/chfn -F perm=x -k privileged
-a always,exit -F path=/usr/bin/newgrp -F perm=x -k privileged
-a always,exit -F path=/usr/bin/gpasswd -F perm=x -k privileged
-a always,exit -F path=/usr/bin/usermod -F perm=x -k privileged
-a always,exit -F path=/usr/sbin/useradd -F perm=x -k privileged
-a always,exit -F path=/usr/sbin/userdel -F perm=x -k privileged
-a always,exit -F path=/usr/sbin/groupadd -F perm=x -k privileged
-a always,exit -F path=/usr/sbin/groupdel -F perm=x -k privileged
-a always,exit -F path=/usr/sbin/groupmod -F perm=x -k privileged

# =============================================================================
# SSH configuration changes
# =============================================================================
-w /etc/ssh/sshd_config -p wa -k sshd_config
-w /etc/ssh/sshd_config.d -p wa -k sshd_config
-w /root/.ssh -p wa -k ssh_keys

# =============================================================================
# Network configuration
# =============================================================================
-w /etc/network/interfaces -p wa -k network_config
-w /etc/network/interfaces.d -p wa -k network_config
-w /etc/hosts -p wa -k network_config
-w /etc/resolv.conf -p wa -k network_config
-w /etc/hostname -p wa -k network_config

# =============================================================================
# Proxmox VE configuration
# =============================================================================
-w /etc/pve -p wa -k proxmox_config
-w /var/lib/pve-cluster -p wa -k proxmox_cluster
-w /etc/vzdump.conf -p wa -k proxmox_backup

# Proxmox CLI tools - VM/container management
-a always,exit -F path=/usr/sbin/qm -F perm=x -k proxmox_vm
-a always,exit -F path=/usr/sbin/pct -F perm=x -k proxmox_container

# Proxmox API and management tools (/usr/bin/)
-a always,exit -F path=/usr/bin/pvesh -F perm=x -k proxmox_api
-a always,exit -F path=/usr/bin/pveam -F perm=x -k proxmox_templates
-a always,exit -F path=/usr/bin/pvecm -F perm=x -k proxmox_cluster
-a always,exit -F path=/usr/bin/pveum -F perm=x -k proxmox_users
-a always,exit -F path=/usr/bin/pvesr -F perm=x -k proxmox_replication
-a always,exit -F path=/usr/bin/pvenode -F perm=x -k proxmox_node
-a always,exit -F path=/usr/bin/pvesubscription -F perm=x -k proxmox_subscription

# Proxmox backup/restore
-a always,exit -F path=/usr/bin/vzdump -F perm=x -k proxmox_backup
-a always,exit -F path=/usr/sbin/qmrestore -F perm=x -k proxmox_restore

# Proxmox storage management
-a always,exit -F path=/usr/bin/pvesm -F perm=x -k proxmox_storage
-a always,exit -F path=/usr/bin/pveceph -F perm=x -k proxmox_ceph

# Proxmox firewall
-w /etc/pve/firewall -p wa -k proxmox_firewall
-a always,exit -F path=/usr/sbin/pve-firewall -F perm=x -k proxmox_firewall

# =============================================================================
# System startup and services
# =============================================================================
-w /etc/rc.local -p wa -k init
-w /etc/init.d -p wa -k init
-w /etc/systemd/system -p wa -k systemd
-w /usr/lib/systemd/system -p wa -k systemd

# =============================================================================
# Kernel modules
# =============================================================================
-a always,exit -F path=/usr/sbin/insmod -F perm=x -k modules
-a always,exit -F path=/usr/sbin/rmmod -F perm=x -k modules
-a always,exit -F path=/usr/sbin/modprobe -F perm=x -k modules
-w /etc/modprobe.d -p wa -k modules

# =============================================================================
# Cron jobs
# =============================================================================
-w /etc/crontab -p wa -k cron
-w /etc/cron.d -p wa -k cron
-w /etc/cron.daily -p wa -k cron
-w /etc/cron.hourly -p wa -k cron
-w /etc/cron.monthly -p wa -k cron
-w /etc/cron.weekly -p wa -k cron
-w /var/spool/cron/crontabs -p wa -k cron

# =============================================================================
# Sudoers configuration
# =============================================================================
-w /etc/sudoers -p wa -k sudoers
-w /etc/sudoers.d -p wa -k sudoers

# =============================================================================
# Time changes
# =============================================================================
-a always,exit -F arch=b64 -S adjtimex -S settimeofday -k time_change
-a always,exit -F arch=b64 -S clock_settime -k time_change
-w /etc/localtime -p wa -k time_change
-w /etc/timezone -p wa -k time_change

# =============================================================================
# Login/logout events
# =============================================================================
-w /var/log/faillog -p wa -k logins
-w /var/log/lastlog -p wa -k logins
-w /var/run/utmp -p wa -k session
-w /var/log/wtmp -p wa -k logins
-w /var/log/btmp -p wa -k logins

# =============================================================================
# PAM configuration
# =============================================================================
-w /etc/pam.d -p wa -k pam
-w /etc/security -p wa -k pam

# =============================================================================
# Package management
# =============================================================================
-a always,exit -F path=/usr/bin/apt -F perm=x -k package_management
-a always,exit -F path=/usr/bin/apt-get -F perm=x -k package_management
-a always,exit -F path=/usr/bin/dpkg -F perm=x -k package_management
-a always,exit -F path=/usr/bin/aptitude -F perm=x -k package_management

# =============================================================================
# Firewall changes (iptables/nftables)
# =============================================================================
-a always,exit -F path=/usr/sbin/iptables -F perm=x -k firewall
-a always,exit -F path=/usr/sbin/ip6tables -F perm=x -k firewall
-a always,exit -F path=/usr/sbin/iptables-restore -F perm=x -k firewall
-a always,exit -F path=/usr/sbin/ip6tables-restore -F perm=x -k firewall
-a always,exit -F path=/usr/sbin/nft -F perm=x -k firewall

# =============================================================================
# ZFS administration (common on Proxmox)
# =============================================================================
-a always,exit -F path=/usr/sbin/zpool -F perm=x -k zfs_admin
-a always,exit -F path=/usr/sbin/zfs -F perm=x -k zfs_admin

# =============================================================================
# Fail2Ban configuration and management
# =============================================================================
-w /etc/fail2ban -p wa -k fail2ban_config
-a always,exit -F path=/usr/bin/fail2ban-client -F perm=x -k fail2ban_admin
-a always,exit -F path=/usr/bin/fail2ban-server -F perm=x -k fail2ban_admin

# =============================================================================
# Make rules immutable (must be last rule)
# =============================================================================
-e 2
