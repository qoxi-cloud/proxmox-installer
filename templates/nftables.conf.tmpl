#!/usr/sbin/nft -f
# =============================================================================
# nftables firewall configuration for Proxmox VE
# Generated by proxmox-installer installer
# Bridge mode: {{BRIDGE_MODE}}
# =============================================================================

flush ruleset

# =============================================================================
# Main filter table for IPv4/IPv6
# =============================================================================
table inet filter {
    chain input {
        type filter hook input priority filter; policy drop;

        # Allow established and related connections (stateful firewall)
        ct state established,related accept

        # Drop invalid packets
        ct state invalid drop

        # Allow loopback interface (required for local services)
        iifname "lo" accept

        # === BRIDGE_INPUT_RULES ===

        # === TAILSCALE_RULES ===

        # ICMPv4: allow essential types with rate limiting
        ip protocol icmp icmp type { echo-request, echo-reply, destination-unreachable, time-exceeded } limit rate 10/second accept

        # ICMPv6: allow essential types (required for IPv6 to work properly)
        ip6 nexthdr icmpv6 icmpv6 type { echo-request, echo-reply, destination-unreachable, packet-too-big, time-exceeded, parameter-problem, nd-router-advert, nd-neighbor-solicit, nd-neighbor-advert } limit rate 10/second accept

        # === FIREWALL_RULES_START ===
        # SSH access (port {{PORT_SSH}})
        tcp dport {{PORT_SSH}} ct state new accept

        # Proxmox Web UI (port {{PORT_PROXMOX_UI}})
        tcp dport {{PORT_PROXMOX_UI}} ct state new accept
        # === FIREWALL_RULES_END ===

        # Everything else is dropped (default policy)
    }

    chain forward {
        type filter hook forward priority filter; policy accept;

        # === BRIDGE_FORWARD_RULES ===

        # Allow established/related
        ct state established,related accept

        # Drop invalid packets
        ct state invalid drop
    }

    chain output {
        type filter hook output priority filter; policy accept;
        # Allow all outbound traffic
    }
}

# =============================================================================
# NAT table for VM internet access (masquerading)
# =============================================================================
table inet nat {
    chain postrouting {
        type nat hook postrouting priority srcnat;

        # === NAT_RULES ===
    }
}
