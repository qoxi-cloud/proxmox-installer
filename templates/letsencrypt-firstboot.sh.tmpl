#!/bin/bash
# First-boot Let's Encrypt certificate obtainment
# Runs once on first boot when the server is accessible from internet

CERT_DOMAIN='{{CERT_DOMAIN}}'
CERT_EMAIL='{{CERT_EMAIL}}'
LOG_FILE='/var/log/letsencrypt-firstboot.log'
MARKER_FILE='/etc/letsencrypt/.certificate-obtained'

# Exit if certificate already obtained
if [[ -f "$MARKER_FILE" ]]; then
	echo "Certificate already obtained, skipping" >>"$LOG_FILE"
	exit 0
fi

echo "Starting Let's Encrypt certificate obtainment at $(date)" >>"$LOG_FILE"

# Wait for network to be fully ready
sleep 10

# Stop pveproxy to free port 443
echo "Stopping pveproxy..." >>"$LOG_FILE"
systemctl stop pveproxy 2>>"$LOG_FILE" || true

# Obtain certificate using standalone mode on port 80
certbot certonly --standalone \
	--non-interactive \
	--agree-tos \
	--email "$CERT_EMAIL" \
	--domain "$CERT_DOMAIN" \
	--preferred-challenges http \
	>>"$LOG_FILE" 2>&1

CERTBOT_EXIT=$?

if [[ $CERTBOT_EXIT -eq 0 ]]; then
	echo "Certificate obtained successfully" >>"$LOG_FILE"

	# Copy certificates to Proxmox location
	# Note: /etc/pve uses pmxcfs which manages permissions automatically
	if cp "/etc/letsencrypt/live/$CERT_DOMAIN/fullchain.pem" /etc/pve/local/pveproxy-ssl.pem 2>>"$LOG_FILE" &&
		cp "/etc/letsencrypt/live/$CERT_DOMAIN/privkey.pem" /etc/pve/local/pveproxy-ssl.key 2>>"$LOG_FILE"; then

		# Create marker file only after successful deployment
		touch "$MARKER_FILE"

		# Enable certbot timer for auto-renewal
		systemctl enable certbot.timer
		systemctl start certbot.timer

		echo "Certificate deployed to Proxmox" >>"$LOG_FILE"
	else
		echo "ERROR: Failed to copy certificates to /etc/pve/local/" >>"$LOG_FILE"
	fi
else
	echo "Failed to obtain certificate (exit code: $CERTBOT_EXIT)" >>"$LOG_FILE"
	echo "Check /var/log/letsencrypt/letsencrypt.log for details" >>"$LOG_FILE"
fi

# Always restart pveproxy to load certificate
echo "Restarting pveproxy..." >>"$LOG_FILE"
if ! systemctl restart pveproxy 2>>"$LOG_FILE"; then
	echo "ERROR: Failed to restart pveproxy" >>"$LOG_FILE"
	systemctl status pveproxy >>"$LOG_FILE" 2>&1
fi

echo "Completed at $(date)" >>"$LOG_FILE"
