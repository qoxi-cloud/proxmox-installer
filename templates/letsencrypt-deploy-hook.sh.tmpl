#!/bin/bash
# Deploy renewed certificate to Proxmox
# Called by certbot after successful renewal

for dir in /etc/letsencrypt/live/*/; do
	[[ -d "$dir" ]] || continue
	DOMAIN=$(basename "$dir")
	[[ "$DOMAIN" == "README" ]] && continue

	FULLCHAIN="/etc/letsencrypt/live/$DOMAIN/fullchain.pem"
	PRIVKEY="/etc/letsencrypt/live/$DOMAIN/privkey.pem"

	# Verify source files exist
	if [[ ! -f "$FULLCHAIN" ]] || [[ ! -f "$PRIVKEY" ]]; then
		echo "ERROR: Certificate files not found for $DOMAIN"
		exit 1
	fi

	# Deploy to Proxmox
	if ! cp "$FULLCHAIN" /etc/pve/local/pveproxy-ssl.pem; then
		echo "ERROR: Failed to copy certificate"
		exit 1
	fi
	if ! cp "$PRIVKEY" /etc/pve/local/pveproxy-ssl.key; then
		echo "ERROR: Failed to copy private key"
		exit 1
	fi
	# Note: /etc/pve uses pmxcfs which manages permissions automatically

	systemctl restart pveproxy
	echo "Certificate renewed and deployed for $DOMAIN"
	exit 0
done

echo "ERROR: No valid certificate found in /etc/letsencrypt/live/"
exit 1
