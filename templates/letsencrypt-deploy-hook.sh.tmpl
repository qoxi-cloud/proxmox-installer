#!/bin/bash
# Deploy renewed certificate to Proxmox
# Find first certificate directory (excluding README)
CERT_FOUND=false
for dir in /etc/letsencrypt/live/*/; do
    [[ -d "$dir" ]] || continue
    DOMAIN=$(basename "$dir")
    if [[ "$DOMAIN" != "README" ]]; then
        FULLCHAIN="/etc/letsencrypt/live/$DOMAIN/fullchain.pem"
        PRIVKEY="/etc/letsencrypt/live/$DOMAIN/privkey.pem"

        # Verify certificate files exist before copying
        if [[ ! -f "$FULLCHAIN" ]]; then
            echo "ERROR: Certificate file not found: $FULLCHAIN"
            exit 1
        fi
        if [[ ! -f "$PRIVKEY" ]]; then
            echo "ERROR: Private key file not found: $PRIVKEY"
            exit 1
        fi

        cp "$FULLCHAIN" /etc/pve/local/pveproxy-ssl.pem
        cp "$PRIVKEY" /etc/pve/local/pveproxy-ssl.key
        chmod 640 /etc/pve/local/pveproxy-ssl.pem
        chmod 600 /etc/pve/local/pveproxy-ssl.key
        systemctl restart pveproxy
        CERT_FOUND=true
        break
    fi
done

if [[ "$CERT_FOUND" != "true" ]]; then
    echo "ERROR: No valid certificate directories found in /etc/letsencrypt/live/"
    exit 1
fi
