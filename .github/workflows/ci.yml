name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for version calculation
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Calculate version
        id: version
        run: |
          # Get MAJOR version from source file
          MAJOR=$(grep -oP 'VERSION="\K[0-9]+' scripts/00-init.sh)

          # Count tags matching vMAJOR.* for MINOR
          MINOR=$(git tag -l "v${MAJOR}.*" 2>/dev/null | wc -l | tr -d ' ')

          # Count commits since last tag for PATCH
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [[ -n "$LATEST_TAG" ]]; then
            PATCH=$(git rev-list "${LATEST_TAG}..HEAD" --count)
          else
            PATCH=$(git rev-list HEAD --count)
          fi

          VERSION="${MAJOR}.${MINOR}.${PATCH}"

          # Add PR suffix for pull request builds
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            VERSION="${VERSION}-pr.${{ github.event.pull_request.number }}"
          fi

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Generated version: ${VERSION}"

      - name: Build script
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Header
          cat > pve-install.sh << 'HEADER'
          #!/usr/bin/env bash
          # =============================================================================
          # Proxmox VE Auto-Installer for Hetzner Dedicated Servers
          # =============================================================================
          HEADER

          # Concatenate all source files in order
          for f in scripts/*.sh; do
            echo "" >> pve-install.sh
            echo "# --- $(basename "$f") ---" >> pve-install.sh
            # Remove shebang from all files
            sed '1{/^#!/d}' "$f" >> pve-install.sh
          done

          # Replace version placeholder with calculated version
          sed -i "s/^VERSION=\"[0-9]*\"$/VERSION=\"${VERSION}\"/" pve-install.sh

          # For PR builds, update GITHUB_BRANCH to use PR branch for templates
          # For fork PRs, templates will come from fork's branch
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            PR_BRANCH="${{ github.event.pull_request.head.ref }}"
            PR_REPO="${{ github.event.pull_request.head.repo.full_name }}"

            # Update GITHUB_BRANCH
            sed -i "s|^GITHUB_BRANCH=\"\${GITHUB_BRANCH:-main}\"|GITHUB_BRANCH=\"\${GITHUB_BRANCH:-${PR_BRANCH}}\"|" pve-install.sh

            # For forks, also update GITHUB_REPO
            if [[ "$PR_REPO" != "${{ github.repository }}" ]]; then
              sed -i "s|^GITHUB_REPO=\"\${GITHUB_REPO:-[^}]*}\"|GITHUB_REPO=\"\${GITHUB_REPO:-${PR_REPO}}\"|" pve-install.sh
            fi
          fi

          chmod +x pve-install.sh

      - name: Install shfmt
        run: |
          curl -sS https://webi.sh/shfmt | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Check formatting with shfmt
        run: |
          # Check if scripts are properly formatted (2-space indent, simplify)
          if ! shfmt -i 2 -ci -s -d scripts/*.sh; then
            echo ""
            echo "::error::Scripts are not properly formatted. Run: shfmt -i 2 -ci -s -w scripts/*.sh"
            exit 1
          fi
          echo "âœ“ All scripts are properly formatted"

      - name: Minify script with shfmt
        run: |
          # Minify: -mn removes comments and minimizes whitespace
          shfmt -mn pve-install.sh > pve-install.min.sh

          # Show size reduction
          ORIGINAL_SIZE=$(wc -c < pve-install.sh)
          MINIFIED_SIZE=$(wc -c < pve-install.min.sh)
          REDUCTION=$((100 - (MINIFIED_SIZE * 100 / ORIGINAL_SIZE)))
          echo "Original: ${ORIGINAL_SIZE} bytes"
          echo "Minified: ${MINIFIED_SIZE} bytes"
          echo "Reduction: ${REDUCTION}%"

          chmod +x pve-install.min.sh

      - name: Lint with ShellCheck
        # SC1003: single quote escape in ASCII art banner (intentional)
        run: shellcheck -e SC1003,SC1091,SC2034,SC2086 scripts/*.sh

      - name: Run unit tests
        run: |
          chmod +x tests/*.sh
          ./tests/run-all-tests.sh

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: pve-install
          path: |
            pve-install.sh
            pve-install.min.sh

      - name: Save PR metadata
        if: github.event_name == 'pull_request'
        run: |
          mkdir -p pr-metadata
          echo "${{ github.event.pull_request.number }}" > pr-metadata/pr_number
          echo "${{ github.event.pull_request.head.ref }}" > pr-metadata/pr_branch
          echo "${{ github.event.pull_request.head.repo.full_name }}" > pr-metadata/pr_repo

      - name: Upload PR metadata
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: pr-metadata
          path: pr-metadata/

  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    permissions:
      contents: write

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: pve-install

      - name: Calculate version for badge
        id: version
        run: |
          VERSION=$(grep '^VERSION=' pve-install.min.sh | head -1 | sed 's/VERSION="//;s/"//')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Deploy to gh-pages
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Copy build artifacts (minified is primary, full for debugging)
          cp pve-install.min.sh gh-pages/
          cp pve-install.sh gh-pages/

          # Generate version.json for shields.io badge
          cat > gh-pages/version.json << EOF
          {
            "schemaVersion": 1,
            "label": "version",
            "message": "${VERSION}",
            "color": "blue"
          }
          EOF

          # Commit and push
          cd gh-pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pve-install.sh pve-install.min.sh version.json
          git commit -m "Deploy version ${VERSION}" || echo "No changes to commit"
          git push origin gh-pages
