name: commit-lint

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened, edited]

jobs:
  commit-lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate commit messages
        run: |
          # Get all commits in this PR
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          echo "Checking commits from ${BASE_SHA}..${HEAD_SHA}"
          echo ""

          # Valid emoji prefixes
          VALID_EMOJIS="âœ¨|ğŸ›|ğŸ”’ï¸|ğŸ”’|â™»ï¸|ğŸ“|ğŸ”§|âš¡ï¸|âš¡|ğŸ©¹|ğŸš‘ï¸|ğŸš‘|âœ…|ğŸ—ï¸|ğŸ—|ğŸ‘·"

          # Valid types
          VALID_TYPES="feat|fix|security|refactor|docs|chore|perf|hotfix|test|build|ci"

          # Pattern: <emoji> <type>: <description>
          PATTERN="^($VALID_EMOJIS) ($VALID_TYPES): .+"

          FAILED=0
          CHECKED=0

          while IFS= read -r COMMIT_SHA; do
            CHECKED=$((CHECKED + 1))
            # Get commit message (first line only)
            MSG=$(git log --format=%s -n 1 "$COMMIT_SHA")

            # Skip merge commits
            if [[ "$MSG" =~ ^Merge ]]; then
              echo "â­ï¸  Skipping merge commit: ${COMMIT_SHA:0:7}"
              continue
            fi

            # Skip bot commits
            AUTHOR=$(git log --format=%an -n 1 "$COMMIT_SHA")
            if [[ "$AUTHOR" == *"[bot]"* ]] || [[ "$AUTHOR" == "GitHub" ]]; then
              echo "â­ï¸  Skipping bot commit: ${COMMIT_SHA:0:7}"
              continue
            fi

            # Validate format
            if [[ "$MSG" =~ $PATTERN ]]; then
              echo "âœ… ${COMMIT_SHA:0:7}: $MSG"
            else
              echo "âŒ ${COMMIT_SHA:0:7}: $MSG"
              echo "   Expected format: <emoji> <type>: <description>"
              echo "   Valid emojis: âœ¨ ğŸ› ğŸ”’ï¸ â™»ï¸ ğŸ“ ğŸ”§ âš¡ï¸ ğŸ©¹ ğŸš‘ï¸ âœ… ğŸ—ï¸ ğŸ‘·"
              echo "   Valid types: feat, fix, security, refactor, docs, chore, perf, hotfix, test, build, ci"
              echo ""
              FAILED=$((FAILED + 1))
            fi
          done < <(git rev-list "${BASE_SHA}..${HEAD_SHA}")

          echo ""
          echo "========================================="
          echo "Checked: $CHECKED commits"
          echo "Failed: $FAILED commits"
          echo "========================================="

          if [[ $FAILED -gt 0 ]]; then
            echo ""
            echo "ğŸ’¡ Commit message format:"
            echo ""
            echo "   <emoji> <type>: <short description>"
            echo ""
            echo "   Example:"
            echo "   âœ¨ feat: add IPv6 support for network bridges"
            echo "   ğŸ› fix: correct DNS resolution timeout"
            echo "   ğŸ“ docs: update installation guide"
            echo ""
            echo "See CONTRIBUTING.md for full guidelines."
            exit 1
          fi

      - name: Validate PR title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"

          # Valid emoji prefixes
          VALID_EMOJIS="âœ¨|ğŸ›|ğŸ”’ï¸|ğŸ”’|â™»ï¸|ğŸ“|ğŸ”§|âš¡ï¸|âš¡|ğŸ©¹|ğŸš‘ï¸|ğŸš‘|âœ…|ğŸ—ï¸|ğŸ—|ğŸ‘·"

          # Valid types
          VALID_TYPES="feat|fix|security|refactor|docs|chore|perf|hotfix|test|build|ci"

          # Pattern: <emoji> <type>: <description>
          PATTERN="^($VALID_EMOJIS) ($VALID_TYPES): .+"

          echo "Checking PR title: $PR_TITLE"
          echo ""

          if [[ "$PR_TITLE" =~ $PATTERN ]]; then
            echo "âœ… PR title follows commit message format"
          else
            echo "âŒ PR title does not follow commit message format"
            echo ""
            echo "Expected format: <emoji> <type>: <description>"
            echo ""
            echo "Examples:"
            echo "  âœ¨ feat: add IPv6 support for network bridges"
            echo "  ğŸ› fix: correct DNS resolution timeout"
            echo "  ğŸ“ docs: update installation guide"
            echo ""
            echo "See CONTRIBUTING.md for full guidelines."
            exit 1
          fi
