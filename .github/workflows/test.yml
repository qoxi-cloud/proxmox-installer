name: tests

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  shellspec:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install gum
        run: |
          sudo mkdir -p /etc/apt/keyrings
          curl -fsSL https://repo.charm.sh/apt/gpg.key | sudo gpg --dearmor -o /etc/apt/keyrings/charm.gpg
          echo "deb [signed-by=/etc/apt/keyrings/charm.gpg] https://repo.charm.sh/apt/ * *" | sudo tee /etc/apt/sources.list.d/charm.list
          sudo apt-get update
          sudo apt-get install -y gum

      - name: Install ShellSpec
        run: |
          curl -fsSL https://git.io/shellspec | sh -s -- --yes
          echo "$HOME/.local/lib/shellspec" >> "$GITHUB_PATH"

      - name: Run tests
        run: shellspec --format documentation --no-kcov

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            report/
          retention-days: 7

  coverage:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          # Install gum
          sudo mkdir -p /etc/apt/keyrings
          curl -fsSL https://repo.charm.sh/apt/gpg.key | sudo gpg --dearmor -o /etc/apt/keyrings/charm.gpg
          echo "deb [signed-by=/etc/apt/keyrings/charm.gpg] https://repo.charm.sh/apt/ * *" | sudo tee /etc/apt/sources.list.d/charm.list
          sudo apt-get update
          sudo apt-get install -y gum kcov

      - name: Install ShellSpec
        run: |
          curl -fsSL https://git.io/shellspec | sh -s -- --yes
          echo "$HOME/.local/lib/shellspec" >> "$GITHUB_PATH"

      - name: Run tests with coverage
        run: shellspec --kcov --kcov-options "--exclude-pattern=/usr,/tmp,spec/"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          directory: ./coverage
          files: ./coverage/shellspec/cobertura.xml
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Coverage summary
        run: |
          if [[ -f coverage/shellspec/index.html ]]; then
            echo "### Test Coverage" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            # Extract coverage percentage if possible
            if grep -oP 'Coverage: \K[0-9.]+%' coverage/shellspec/index.html >/dev/null 2>&1; then
              coverage=$(grep -oP 'Coverage: \K[0-9.]+%' coverage/shellspec/index.html)
              echo "Coverage: $coverage" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "Coverage report generated" >> "$GITHUB_STEP_SUMMARY"
            fi
          fi
