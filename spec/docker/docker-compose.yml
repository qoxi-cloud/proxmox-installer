# Integration test containers
# Usage: docker compose -f spec/docker/docker-compose.yml up -d

services:
  sshd:
    build:
      context: .
      dockerfile: Dockerfile.sshd
    container_name: integration-sshd
    ports:
      - "2222:22"
    networks:
      - integration
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "22"]
      interval: 2s
      timeout: 5s
      retries: 10

  target:
    build:
      context: .
      dockerfile: Dockerfile.target
    container_name: integration-target
    privileged: true
    networks:
      - integration
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
    tmpfs:
      - /run
      - /run/lock
    healthcheck:
      test: ["CMD", "systemctl", "is-system-running", "--quiet"]
      interval: 5s
      timeout: 10s
      retries: 12
      start_period: 10s

  # Mock HTTP server for download tests
  httpserver:
    build:
      context: .
      dockerfile: Dockerfile.httpserver
    container_name: integration-httpserver
    ports:
      - "8888:80"
    networks:
      - integration
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/iso/"]
      interval: 2s
      timeout: 5s
      retries: 5

  # ZFS tools container for command validation tests
  # NOTE: Actual ZFS pool creation requires host kernel modules
  zfstools:
    build:
      context: .
      dockerfile: Dockerfile.zfstools
    container_name: integration-zfstools
    networks:
      - integration
    # Keep container running
    command: ["sleep", "infinity"]
    healthcheck:
      test: ["CMD", "which", "zpool"]
      interval: 5s
      timeout: 5s
      retries: 3

networks:
  integration:
    driver: bridge

