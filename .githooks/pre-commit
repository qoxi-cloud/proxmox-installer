#!/usr/bin/env bash
# Pre-commit hook: runs shellcheck and shfmt on staged .sh files
set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

# Get staged .sh files (exclude spec files - ShellSpec DSL not compatible with shfmt)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.sh$' || true)
STAGED_FILES_NO_SPEC=$(echo "$STAGED_FILES" | grep -v '^spec/' || true)

if [[ -z "$STAGED_FILES" ]]; then
  exit 0
fi

ERRORS=0

# Check if shellcheck is installed
if ! command -v shellcheck &>/dev/null; then
  echo -e "${YELLOW}⚠ shellcheck not found, skipping lint check${NC}"
else
  echo -e "${NC}Running shellcheck...${NC}"
  for file in $STAGED_FILES; do
    if [[ -f "$file" ]]; then
      if ! shellcheck "$file" 2>&1; then
        echo -e "${RED}✗ shellcheck failed: $file${NC}"
        ERRORS=1
      fi
    fi
  done
  if [[ $ERRORS -eq 0 ]]; then
    echo -e "${GREEN}✓ shellcheck passed${NC}"
  fi
fi

# Check if shfmt is installed
if ! command -v shfmt &>/dev/null; then
  echo -e "${YELLOW}⚠ shfmt not found, skipping format check${NC}"
else
  echo -e "${NC}Running shfmt...${NC}"
  UNFORMATTED=""
  # Use STAGED_FILES_NO_SPEC - spec files use ShellSpec DSL incompatible with shfmt
  for file in $STAGED_FILES_NO_SPEC; do
    if [[ -f "$file" ]]; then
      if ! shfmt -d "$file" &>/dev/null; then
        UNFORMATTED="$UNFORMATTED $file"
      fi
    fi
  done

  if [[ -n "$UNFORMATTED" ]]; then
    echo -e "${RED}✗ shfmt: files need formatting:${NC}"
    for file in $UNFORMATTED; do
      echo "  $file"
    done
    echo -e "${YELLOW}Run: shfmt -w$UNFORMATTED${NC}"
    ERRORS=1
  else
    echo -e "${GREEN}✓ shfmt passed${NC}"
  fi
fi

if [[ $ERRORS -ne 0 ]]; then
  echo -e "\n${RED}Pre-commit checks failed. Fix errors before committing.${NC}"
  exit 1
fi

exit 0
