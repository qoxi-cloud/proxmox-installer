#!/usr/bin/env bash
# =============================================================================
# Git commit-msg hook - validates commit message format
# =============================================================================

set -euo pipefail

COMMIT_MSG_FILE="$1"
COMMIT_MSG=$(head -1 "$COMMIT_MSG_FILE")

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m'

# Skip merge commits
if [[ "$COMMIT_MSG" =~ ^Merge ]]; then
    exit 0
fi

# Skip fixup/squash commits
if [[ "$COMMIT_MSG" =~ ^(fixup|squash)! ]]; then
    exit 0
fi

# Valid emoji prefixes (with and without variation selector)
VALID_EMOJIS="âœ¨|ğŸ›|ğŸ”’ï¸|ğŸ”’|â™»ï¸|ğŸ“|ğŸ”§|âš¡ï¸|âš¡|ğŸ©¹|ğŸš‘ï¸|ğŸš‘|âœ…|ğŸ—ï¸|ğŸ—|ğŸ‘·"

# Valid types
VALID_TYPES="feat|fix|security|refactor|docs|chore|perf|hotfix|test|build|ci"

# Pattern: <emoji> <type>: <description>
PATTERN="^($VALID_EMOJIS) ($VALID_TYPES): .+"

if [[ "$COMMIT_MSG" =~ $PATTERN ]]; then
    echo -e "${GREEN}âœ“${NC} Commit message format is valid"
    exit 0
else
    echo -e "${RED}âœ—${NC} Invalid commit message format"
    echo ""
    echo -e "${YELLOW}Your message:${NC}"
    echo "  $COMMIT_MSG"
    echo ""
    echo -e "${YELLOW}Expected format:${NC}"
    echo "  <emoji> <type>: <short description>"
    echo ""
    echo -e "${YELLOW}Valid emojis:${NC}"
    echo "  âœ¨ feat      - New features"
    echo "  ğŸ› fix       - Bug fixes"
    echo "  ğŸ”’ï¸ security  - Security fixes"
    echo "  â™»ï¸ refactor  - Code restructuring"
    echo "  ğŸ“ docs      - Documentation"
    echo "  ğŸ”§ chore     - Configuration, tooling"
    echo "  âš¡ï¸ perf      - Performance improvements"
    echo "  ğŸ©¹ fix       - Simple non-critical fixes"
    echo "  ğŸš‘ï¸ hotfix    - Critical hotfixes"
    echo "  âœ… test      - Adding or updating tests"
    echo "  ğŸ—ï¸ build     - Build system changes"
    echo "  ğŸ‘· ci        - CI/CD changes"
    echo ""
    echo -e "${YELLOW}Examples:${NC}"
    echo "  âœ¨ feat: add IPv6 support for network bridges"
    echo "  ğŸ› fix: correct DNS resolution timeout"
    echo "  ğŸ“ docs: update installation guide"
    echo ""
    echo "See CONTRIBUTING.md for full guidelines."
    exit 1
fi
