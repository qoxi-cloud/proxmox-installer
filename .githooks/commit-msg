#!/usr/bin/env python3
"""
Pre-commit hook to validate commit message format and block Claude Code footer.
"""
import sys
import re

# Valid emoji prefixes (with and without variation selector)
VALID_EMOJIS = r'âœ¨|ğŸ›|ğŸ”’ï¸|ğŸ”’|â™»ï¸|ğŸ“|ğŸ”§|âš¡ï¸|âš¡|ğŸ©¹|ğŸš‘ï¸|ğŸš‘|âœ…|ğŸ—ï¸|ğŸ—|ğŸ‘·'

# Valid types
VALID_TYPES = r'feat|fix|security|refactor|docs|chore|perf|hotfix|test|build|ci'

# Pattern: <emoji> <type>: <description>
COMMIT_PATTERN = rf'^({VALID_EMOJIS}) ({VALID_TYPES}): .+'

EMOJI_REFERENCE = """
  âœ¨ feat      - New features
  ğŸ› fix       - Bug fixes
  ğŸ”’ï¸ security  - Security fixes
  â™»ï¸ refactor  - Code restructuring
  ğŸ“ docs      - Documentation
  ğŸ”§ chore     - Configuration, tooling
  âš¡ï¸ perf      - Performance improvements
  ğŸ©¹ fix       - Simple non-critical fixes
  ğŸš‘ï¸ hotfix    - Critical hotfixes
  âœ… test      - Adding or updating tests
  ğŸ—ï¸ build     - Build system changes
  ğŸ‘· ci        - CI/CD changes
"""


def check_commit_message(commit_msg_file):
    with open(commit_msg_file, 'r') as f:
        message = f.read()

    first_line = message.split('\n')[0]

    # Skip merge commits
    if first_line.startswith('Merge'):
        sys.exit(0)

    # Skip fixup/squash commits
    if re.match(r'^(fixup|squash)!', first_line):
        sys.exit(0)

    # Check for blocked patterns (Claude Code footer)
    blocked_patterns = [
        r'ğŸ¤– Generated with \[Claude Code\]',
        r'Co-Authored-By: Claude <noreply@anthropic\.com>',
    ]

    for pattern in blocked_patterns:
        if re.search(pattern, message):
            print(f"\nâŒ ERROR: Commit message contains blocked pattern: {pattern}")
            print("\nThe following lines are not allowed in commit messages:")
            print("  - ğŸ¤– Generated with [Claude Code](...)")
            print("  - Co-Authored-By: Claude <noreply@anthropic.com>")
            print("\nPlease remove these lines from your commit message.\n")
            sys.exit(1)

    # Validate commit message format
    if re.match(COMMIT_PATTERN, first_line):
        print("âœ“ Commit message format is valid")
        sys.exit(0)
    else:
        print("âŒ Invalid commit message format")
        print("")
        print("Your message:")
        print(f"  {first_line}")
        print("")
        print("Expected format:")
        print("  <emoji> <type>: <short description>")
        print("")
        print("Valid emojis:")
        print(EMOJI_REFERENCE)
        print("")
        print("Examples:")
        print("  âœ¨ feat: add IPv6 support for network bridges")
        print("  ğŸ› fix: correct DNS resolution timeout")
        print("  ğŸ“ docs: update installation guide")
        print("")
        print("See CONTRIBUTING.md for full guidelines.")
        sys.exit(1)


if __name__ == '__main__':
    if len(sys.argv) < 2:
        print("Usage: commit-msg <commit-msg-file>")
        sys.exit(1)

    check_commit_message(sys.argv[1])
